# Crystal - Requirements Document

## Executive Summary

Crystal is a desktop application that enables developers to run multiple Claude Code instances simultaneously against a single codebase using git worktrees. This allows exploration of different implementation approaches in parallel without conflicts, with each session operating in an isolated git worktree.

Crystal should be written with Electron so that it can be deployed as a desktop application

You must use the Claude Code SDK commands with -p --output-format stream-json --dangerously-skip-permissions. The documentation for SDK mode is at the bottom of this document.

## Project Goals

### Primary Objectives
1. Enable parallel exploration of different coding approaches using multiple Claude Code instances
2. Prevent conflicts between concurrent development sessions through git worktree isolation
3. Provide a professional, intuitive interface for managing multiple AI coding sessions
4. Maintain complete session history and enable conversation continuation
5. Support multiple projects with project-specific configurations

### Target Users
- Software developers using Claude Code for development tasks
- Teams exploring multiple implementation strategies
- Developers who want to compare different AI-generated solutions
- Users who need to manage complex, multi-session coding workflows

## Functional Requirements

### 1. Session Management

#### 1.1 Session Creation
- Multiple session creation: Support creating 1-10 sessions from a single prompt template
- Session naming: Short session names can be provided by the user or generated using anthropic if an API key is provided. If there is no api key, they can also be generated by hypenating the first three words of the prompt.
- Worktree templates: Support numbered worktree naming (e.g., "feature-1", "feature-2"). If there is ever an existing branch or worktree folder using a name, just increment the number
- Project association: All sessions must be associated with an active project

#### 1.2 Session Lifecycle
- States: Support these session states:
- initializing: Session being created
- ready: Worktree created, Claude not started
- running: Claude Code actively processing
- waiting: Claude Code waiting for input
- stopped: Session terminated
- completed\_unviewed: Session completed with new content
- error: Session encountered an error
- executing: Session's run script is currently executing
- Persistence: Sessions must persist across application restarts. Use a local database (sqllite or something similar, it is up to you)
- Recovery: Ability to recover and continue sessions after crashes

#### 1.3 Session Operations
The initial prompt should be sent to Claude Code.
- Input handling: Send text input to active Claude Code instance
- Output streaming: Real-time streaming of Claude's responses
- Conversation continuation: Resume conversations with full history context (--resume <session\_id>)
- Session archiving: Mark sessions as archived instead of deleting
- Worktree cleanup: Automatic cleanup when sessions are deleted

### 

#### 

#### 

#### 1.4 Session Execution
### 

- Run script execution: Each session can execute the project's run script command within its worktree
- Single execution: Only one session can have its run script executing at a time
- Automatic termination: Starting execution on a new session automatically stops any currently executing session
- Manual control: Users can manually start and stop session execution
- Terminal output: Display real-time terminal output from the executing run script
- Execution tracking: Track execution status and duration for each session
#### 

### 2. Project Management
#### 

#### 2.1 Project Configuration
### 

- Multiple projects: Support for multiple git repositories
- Project metadata:
- Name and description
- Git repository path
- Custom system prompt (optional)
- Run script command (optional)
- Active status
- Project switching: Ability to switch active project
- Default behavior: Use global settings when project-specific settings absent
#### 

#### 2.2 Project-Session Relationship
#### 

- Session grouping: Sessions grouped by project
- Project context: Each session inherits project's system prompt and settings
- Independent operation: Projects operate independently
#### 

### 3. Git Integration
#### 

#### 3.1 Worktree Management
### 

- Automatic creation: Create git worktrees for each session
- Naming convention: Support custom worktree naming templates
- Branch management: Each worktree on its own branch
- Cleanup: Remove worktrees when sessions deleted
#### 

#### 3.2 Change Tracking
#### 

- Execution tracking: Track git state before/after each prompt execution
- Diff capture: Store git diffs for each execution
- File statistics: Track files added, modified, deleted
- Commit tracking: Record commit hashes before/after changes
### 

### 4. User Interface
#### 

#### 4.1 Layout Requirements
#### 

- Sidebar: Left panel showing:
- Project selector dropdown
- Session list with status indicators
- Create session button
- Settings access
- Main area: Terminal or message view
- Header: Current session info and controls
#### 

#### 4.2 Session Display
### 

- Visual indicators: Clear status indicators for each session state
- Session info: Display name, status, creation time
- Active indicator: Highlight currently selected session
- Unread notifications: Badge for completed unviewed sessions
- Execution controls: Run/stop buttons for each session
- Execution indicator: Visual indicator showing which session (if any) is currently executing
#### 

#### 4.3 Terminal Interface
#### 

- Professional terminal: Full-featured terminal emulator
- Theme support: Customizable terminal themes
- Copy/paste: Standard terminal copy/paste functionality
- Scrollback: Unlimited scrollback buffer
- Text selection: Mouse-based text selection
- Dual mode: Support both Claude Code output and run script execution output
- Clear separation: Visual distinction between Claude output and execution output
## 

#### 4.4 Alternative Views
### 

- JSON message view: Structured view of Claude's tool usage
- Prompt history: View of all prompts sent in session
- Diff viewer: Visual diff display for code changes
### 

### 5. Real-time Communication
### 

#### 5.1 Status Updates
### 

- Live status: Real-time session status updates
- Progress indicators: Show when Claude is processing
- Error notifications: Immediate error state communication
## 

#### 5.2 Output Streaming
### 

- Character streaming: Stream output character by character
- Performance: Handle high-volume output without lag
- History preservation: Store all output in database
### 

### 6. Data Persistence
## 

#### 6.1 Session Data
### 

- Metadata: Session ID, name, prompt, status, timestamps
- Output history: Complete terminal output from both Claude Code and run script execution
- Conversation history: All messages for continuation
- Execution tracking: Git diffs and file changes
- Run history: History of run script executions including output, exit codes, and duration
### 

#### 6.2 Configuration
### 

- Application settings: Model selection, API keys, paths
- Project settings: Per-project configurations
- User preferences: UI preferences, themes
### 
#### 6.3 Database Requirements
- Local storage: SQLite database for all data
- Migration support: Schema versioning and migrations
- Data integrity: Proper constraints and relationships
### 7. Claude Code Integration
#### 7.1 SDK Integration
- Official SDK: Use @anthropic-ai/claude-code
- Process management: Spawn and manage Claude processes
- Error handling: Graceful handling of Claude errors
#### 7.2 Communication
- Input forwarding: Pass user input to Claude
- Output capture: Capture all Claude output
- Tool execution: Support for Claude's tool usage
## Non-Functional Requirements
### 2. Reliability
- Crash recovery: Recover from unexpected shutdowns
- Data durability: No data loss on crashes
- Process isolation: One session crash doesn't affect others
- Error handling: Graceful degradation on errors
### 3. Usability
- Intuitive UI: Minimal learning curve
- Keyboard shortcuts: Power user shortcuts
- Responsive design: Adapt to window resizing
- Clear feedback: Obvious status indicators
- Undo operations: Ability to recover from mistakes
### 4. Security
- API key storage: Secure storage of API keys
- Process isolation: Sessions isolated from each other
- No external access: All data stored locally
- Safe file operations: Prevent accidental file deletion
### 5. Compatibility
- Cross-platform: Support macOS, Windows, Linux
- Git versions: Compatible with Git 2.20+
- Node versions: Support Node 18+
- Screen sizes: Support 1280x720 minimum
## Technical Requirements
### 1. Architecture
- Electron application: Desktop app using Electron
- Monorepo structure: Organized as pnpm workspace
- TypeScript: Full TypeScript coverage
- Modern React: React 19 with hooks
### 5. Development
- Hot reload: Fast development iteration
- Type checking: Comprehensive TypeScript types
- Linting: Consistent code style
- Testing: Unit and integration tests

### Reference Documentation
Check Documentation.md